<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Imsakiyah Otomatis 1447 H</title>
    
    <script src="https://unpkg.com/adhan@4.4.3/lib/bundles/adhan.umd.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            --primary-green: #065f46;
            --gradient-green: #047857;
            --light-green: #ecfdf5;
            --accent-orange: #d97706;
            --light-orange: #fffbeb;
            --pdf-red: #dc2626;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --white: #ffffff;
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            background-color: #f3f4f6; 
            color: var(--text-main); 
            margin: 0;
            padding: 20px;
            display: flex; 
            flex-direction: column;
            align-items: center;
        }

        .main-container { 
            max-width: 950px; 
            width: 100%;
        }

        #printable-card {
            background: var(--white);
            padding: 30px; 
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            position: relative; 
            text-align: center; 
        }

        /* --- LOGO --- */
        .logo-container {
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            width: 100%; 
        }

        .center-logo-group {
            display: flex;
            gap: 20px; 
            justify-content: center;
            align-items: center;
        }

        .logo-img {
            max-width: 90px; 
            height: auto;
            object-fit: contain; 
        }

        /* --- TYPOGRAPHY --- */
        h1 { 
            text-align: center; 
            color: var(--primary-green); 
            margin-bottom: 5px;
            margin-top: 0; 
            font-size: 1.8rem;
            letter-spacing: -0.02em;
        }

        .subtitle { 
            text-align: center; 
            color: var(--text-muted); 
            margin-bottom: 25px; 
            font-size: 0.95rem;
            line-height: 1.6;
        }

        /* --- TOMBOL --- */
        .action-buttons-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px; 
        }

        .btn-download {
            padding: 10px 24px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.95rem;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn-download:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .btn-download:active { transform: scale(0.98); }
        .btn-img { background-color: var(--accent-orange); }
        .btn-pdf { background-color: var(--pdf-red); }

        /* --- TABEL PREMIUM --- */
        .table-wrapper {
            width: 100%;
            overflow: visible; 
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            background: white;
        }

        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
        }

        /* Header Bergradasi */
        th { 
            background: linear-gradient(135deg, var(--primary-green) 0%, var(--gradient-green) 100%);
            color: var(--white); 
            font-weight: 700; 
            text-transform: uppercase; 
            font-size: 0.8rem; 
            letter-spacing: 0.05em;
            padding: 16px 8px; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        /* Sel Tabel */
        td { 
            padding: 12px 8px; 
            text-align: center; 
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.9rem;
            transition: background-color 0.2s ease;
        }

        /* Striping warna baris yang sangat lembut */
        tr:nth-child(even) td { background-color: #fafafa; }
        
        /* Efek Hover Baris */
        tbody tr {
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }
        tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            position: relative;
            z-index: 10;
            background-color: white;
        }
        tbody tr:hover td {
            background-color: white;
            border-bottom-color: transparent;
        }
        
        /* Kolom Teks Khusus */
        .hijri-col { font-weight: 700; color: var(--primary-green); text-align: center; }
        .date-col { text-align: center; font-weight: 600; color: #4b5563; }
        
        /* --- PENYOROTAN WAKTU KRUSIAL --- */
        .highlight-imsak { 
            background-color: var(--light-orange) !important; 
            color: var(--accent-orange); 
            font-weight: 800; 
        }
        .highlight-maghrib { 
            background-color: var(--light-green) !important; 
            color: var(--primary-green); 
            font-weight: 800; 
        }

        #status-message {
            text-align: center; padding: 20px; font-style: italic; color: var(--accent-orange);
        }

        /* --- RESPONSIVE MOBILE (CARD LAYOUT) --- */
        @media (max-width: 768px) {
            .action-buttons-container {
                flex-direction: column;
            }

            table thead {
                display: none;
            }

            table, tbody, tr, td {
                display: block;
                width: 100%;
                box-sizing: border-box;
            }

            tr {
                margin-bottom: 20px;
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                box-shadow: 0 4px 10px rgba(0,0,0,0.05);
                overflow: hidden;
            }

            td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 15px;
                text-align: right;
                border-bottom: 1px solid #f3f4f6;
            }

            td:last-child {
                border-bottom: none;
            }

            td::before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-muted);
                text-transform: uppercase;
                font-size: 0.8rem;
            }

            .hijri-col {
                background: linear-gradient(135deg, var(--primary-green) 0%, var(--gradient-green) 100%);
                color: white;
                justify-content: center;
                font-size: 1.05rem;
            }
            .hijri-col::before { display: none; } 
            
            .date-col {
                justify-content: center;
                background-color: #f9fafb;
                font-size: 0.9rem;
            }
            .date-col::before { display: none; }
        }
    </style>
</head>
<body>

<div class="main-container">
    <div id="printable-card">
        <div id="status-message">Sedang mendeteksi lokasi... Mohon izinkan akses lokasi.</div>
        
        <div id="content" style="display:none;">
            
            <div class="logo-container">
                <img src="logokph.png" alt="Logo KPH" class="logo-img" onerror="this.style.display='none'">
                <div class="center-logo-group">
                    <img src="logokms.png" alt="Logo KMS" class="logo-img" onerror="this.style.display='none'">
                    <img src="logoksj.png" alt="Logo KSJ" class="logo-img" onerror="this.style.display='none'">
                </div>
                <img src="logombl.png" alt="Logo MBL" class="logo-img" onerror="this.style.display='none'">
            </div>

            <h1>Jadwal Imsakiyah <br>Puasa Ramadhan 1447 H / 2026 M</h1>
            <div class="subtitle">
                <strong id="location-name">Lokasi Tidak Terdeteksi</strong><br>
                Metode Hisab Kemenag RI â€¢ Awal Ramadhan: Kamis, 19 Februari 2026
            </div>

            <div class="action-buttons-container" id="btnContainer" data-html2canvas-ignore="true">
                <button onclick="downloadJadwal('image')" class="btn-download btn-img">
                    ðŸ“· Simpan Gambar
                </button>
                <button onclick="downloadJadwal('pdf')" class="btn-download btn-pdf">
                    ðŸ“„ Simpan PDF (A4)
                </button>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Hari Ke</th>
                            <th>Tanggal</th>
                            <th>Imsak</th>
                            <th>Subuh</th>
                            <th>Zuhur</th>
                            <th>Ashar</th>
                            <th>Maghrib</th>
                            <th>Isya</th>
                        </tr>
                    </thead>
                    <tbody id="scheduleBody"></tbody>
                </table>
            </div>
            
            <div style="margin-top: 25px; text-align: center; font-size: 0.75rem; color: #9ca3af;">
                *Jadwal ini dihitung secara otomatis berdasarkan koordinat lokasi Anda.
            </div>
        </div>
    </div>
</div>

<script>
    const { jsPDF } = window.jspdf;
    const START_DATE = new Date(2026, 1, 19); 
    const DEFAULT_COORDS = { lat: -6.2000, lng: 106.8167 }; 

    function init() {
        if (navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(onPositionFound, onPositionError);
        } else {
            onPositionError();
        }
    }

    function onPositionFound(position) {
        const { latitude, longitude } = position.coords;
        updateLocationName(latitude, longitude);
        generateSchedule(latitude, longitude);
    }

    function onPositionError() {
        alert("Akses lokasi gagal. Menggunakan lokasi default (Jakarta).");
        document.getElementById('location-name').innerText = "Jakarta Pusat (Default)";
        generateSchedule(DEFAULT_COORDS.lat, DEFAULT_COORDS.lng);
    }

    function updateLocationName(lat, lng) {
        fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=id`)
            .then(res => res.json())
            .then(data => {
                const areaInfo = [
                    data.locality,
                    data.city,
                    data.principalSubdivision
                ];

                const fullLocation = areaInfo.filter(item => item).join(", ");
                const finalLocation = fullLocation || "Lokasi Anda";

                document.getElementById('location-name').innerText = `Wilayah: ${finalLocation} (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
            })
            .catch(() => {
                document.getElementById('location-name').innerText = `Koordinat: (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
            });
    }

    function generateSchedule(lat, lng) {
        document.getElementById('status-message').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        document.getElementById('btnContainer').style.display = 'flex'; 

        const coords = new adhan.Coordinates(lat, lng);
        const params = adhan.CalculationMethod.Singapore();
        params.fajrAngle = 20;
        params.ishaAngle = 18;
        params.adjustments = { fajr: 2, dhuhr: 2, asr: 2, maghrib: 2, isha: 2 };

        const tbody = document.getElementById('scheduleBody');
        tbody.innerHTML = ''; 

        const fmt = new Intl.DateTimeFormat('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false });
        const dateFmt = new Intl.DateTimeFormat('id-ID', { weekday: 'short', day: 'numeric', month: 'short' });

        for (let i = 0; i < 30; i++) {
            let cur = new Date(START_DATE);
            cur.setDate(START_DATE.getDate() + i);
            const p = new adhan.PrayerTimes(coords, cur, params);
            const imsak = new Date(p.fajr); imsak.setMinutes(imsak.getMinutes() - 10);

            // Penambahan data-label agar responsif di mobile
            tbody.innerHTML += `
                <tr>
                    <td class="hijri-col">${i + 1} Ramadhan</td>
                    <td class="date-col">${dateFmt.format(cur)}</td>
                    <td class="highlight-imsak" data-label="Imsak">${fmt.format(imsak)}</td>
                    <td data-label="Subuh">${fmt.format(p.fajr)}</td>
                    <td data-label="Zuhur">${fmt.format(p.dhuhr)}</td>
                    <td data-label="Ashar">${fmt.format(p.asr)}</td>
                    <td class="highlight-maghrib" data-label="Maghrib">${fmt.format(p.maghrib)}</td>
                    <td data-label="Isya">${fmt.format(p.isha)}</td>
                </tr>`;
        }
    }

    function downloadJadwal(type) {
        const element = document.getElementById("printable-card");
        const fileName = "Jadwal-Imsakiyah-1447H";

        const options = {
            scale: 2, 
            useCORS: true, 
            allowTaint: true,
            backgroundColor: "#ffffff",
            windowWidth: 1024 // <-- Memaksa render menggunakan ukuran layar desktop
        };

        html2canvas(element, options).then(canvas => {
            if (type === 'image') {
                const link = document.createElement('a');
                link.download = `${fileName}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            } else if (type === 'pdf') {
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth(); 
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 10; 
                
                const maxPrintWidth = pageWidth - (margin * 2);
                const maxPrintHeight = pageHeight - (margin * 2);

                const imgWidth = canvas.width;
                const imgHeight = canvas.height;

                const widthRatio = maxPrintWidth / imgWidth;
                const heightRatio = maxPrintHeight / imgHeight;
                const ratio = Math.min(widthRatio, heightRatio);

                const finalWidth = imgWidth * ratio;
                const finalHeight = imgHeight * ratio;

                const xPosition = (pageWidth - finalWidth) / 2;
                const yPosition = (pageHeight - finalHeight) / 2;

                pdf.addImage(canvas.toDataURL("image/png"), 'PNG', xPosition, yPosition, finalWidth, finalHeight);
                pdf.save(`${fileName}.pdf`);
            }
        }).catch(err => alert("Gagal menyimpan. Jika menjalankan file ini secara lokal (file:///), browser mungkin memblokir akses ke gambar (CORS). Coba gunakan local web server. Error: " + err));
    }

    init();
</script>

</body>
</html>